<extend name="Public/base" />

<block name="body">
	<script type="text/javascript" src="__STATIC__/uploadify/jquery.uploadify.min.js"></script>
	<div class="main-title cf">
		<h2>
			编辑策略
		</h2>
	</div>
	<!-- 标签页导航 -->
<div class="tab-wrap">
	<div class="tab-content">
	<!-- 表单 -->
	<form id="form" action="{:U('update')}" method="post" class="form-horizontal">
		<input type="hidden" name="id" value="{$data.id}">
		<input type="hidden" name="filters" value="">
		<input type="hidden" name="run_filter_url" value="{:U('run_filter')}">
		<input type="hidden" name="stocks_url" value="{:U('stocks')}">
		<!-- 基础文档模型 -->
        <div id="tab">
            <div class="form-item">
				<label class="item-label">名字<span class="check-tips"></span></label>
				<div class="controls">
					<input type="text" class="text input-large" name='title' value="{$data['title']|default=''}"/>
				</div>
			</div>
			<div class="form-item">
				<label class="item-label">描述<span class="check-tips"></span></label>
				<div class="controls">
					<textarea class="text input-large" style="height:70px;" name="attr">{$data['attr']|default=''}</textarea>
				</div>
			</div>
			<div class="form-item">
				<div class="controls">
					<input type="file" id="upload_picture_img">
					<input type="hidden" name="img" id="cover_id_img" value="{$data['img']}"/>
					<div class="upload-img-box">
					<notempty name="data['img']">
						<div class="upload-pre-item"><img src="__ROOT__{$data['img']|get_cover='path'}"/></div>
					</notempty>
					</div>
				</div>
				<script type="text/javascript">
					//上传图片
					/* 初始化上传插件 */
					$("#upload_picture_img").uploadify({
						"height"          : 30,
						"swf"             : "__STATIC__/uploadify/uploadify.swf",
						"fileObjName"     : "download",
						"buttonText"      : "上传图片",
						"uploader"        : "{:U('File/uploadPicture',array('session_id'=>session_id()))}",
						"width"           : 120,
						'removeTimeout'	  : 1,
						'fileTypeExts'	  : '*.jpg; *.png; *.gif;',
						"onUploadSuccess" : uploadPicture{$field.name},
						'onFallback' : function() {
							alert('未检测到兼容版本的Flash.');
						}
					});
					function uploadPicture{$field.name}(file, data){
						var data = $.parseJSON(data);
						var src = '';
						if(data.status){
							$("#cover_id_img").val(data.id);
							src = data.url || '__ROOT__' + data.path
							$("#cover_id_img").parent().find('.upload-img-box').html(
							    '<div class="upload-pre-item"><img src="' + src + '"/></div>'
							);
						} else {
							updateAlert(data.info);
							setTimeout(function(){
							    $('#top-alert').find('button').click();
							    $(that).removeClass('disabled').prop('disabled',false);
							},1500);
						}
					}
				</script>
			</div>
			<div class="form-item">
				<label class="item-label">类型<span class="check-tips"></span></label>
				<div class="controls">
				<select name="type">
	                <volist name="types" id="vo">
	                    <option value="{$key}" <eq name="data['type']" value="$key">selected</eq>>{$vo}</option>
	                </volist>
	            </select>
	        	</div>
			</div>
			<div class="form-item">
				<label class="item-label">状态<span class="check-tips"></span></label>
				<div class="controls">
				<select name="status">
	                <volist name="statuses" id="vo">
	                    <option value="{$key}" <eq name="data['status']" value="$key">selected</eq>>{$vo}</option>
	                </volist>
	            </select>
	        	</div>
			</div>
			<table>
				<tr>
					<td valign='top' style="width:650px;min-height:500px;">
			<div class="form-item">
				<label class="item-label">过滤条件<span class="check-tips"></span>
					<span class="btn" id="add_filter">增加过滤器</span>
					<span class="btn" id="run_filter">测试过滤器</span>
				</label>
				<div class="controls" id="filters">
					<volist name="data['filters']" id="vo" key="k">
						<div class="filter" style="line-height:35px;clear:both;">
							<div style="float:left;width:25px;">
								<input type="checkbox" name="join" checked>
							</div>
							<div style="float:left;width:200px;">
								<select class="stock_filter_class">
								<volist name="stockFilters" id="filter">
								<option value="{$filter.name}"  data-type="{$filter.type}" <eq name="vo['filter']" value="$filter.name">selected</eq>>{$filter.title}</option>
								</volist>
								</select>
							</div>
							<div class="condition_class" style="float:left;min-width:120px;">
								<eq name="vo['type']" value="num">
								<div class="type type_num">
									<input type="text" name="condition" value="{$vo['condition']}" class="text" style="width:100px;"/>
								</div>
								</eq>
								<eq name="vo['type']" value="str">
								<div class="type type_str">
									<input type="radio" name="bool{$k}" value="true" <eq name="vo['bool']" value="true"> checked</eq>>包含
									<input type="radio" name="bool{$k}" value="false" <eq name="vo['bool']" value="false"> checked</eq>>不包含 
									<input type="text" name="condition" value="{$vo['condition']}" class="text" style="width:70px;"/>
								</div>
								</eq>
								<eq name="vo['type']" value="bool">
								<div class="type type_bool">
									&nbsp;
								</div>
								</eq>
								<eq name="vo['type']" value="num_menu">
								<div class="type type_num_menu">
									<select name="menu">
										<option>筹资现金</option>
										<option>经营现金</option>
										<option>投资现金</option>
									</select>
									<input type="text" name="condition" value="{$vo['condition']}" class="text" style="width:70px;"/>
								</div>
								</eq>
								<eq name="vo['type']" value="num_day1">
								<div class="type type_num_day1">
									近<input type="text" name="day1" value="{$vo['day1']}" class="text" style="width:30px;"/>天，
									<input type="text" name="condition" value="{$vo['condition']}" class="text" style="width:70px;"/>
								</div>
								</eq>
								<eq name="vo['type']" value="num_day2">
								<div class="type type_num_day2">
									从<input type="text" name="day1" value="{$vo['day1']}" class="text" style="width:30px;"/>天，
									到<input type="text" name="day2" value="{$vo['day2']}" class="text" style="width:30px;"/>天，
									<input type="text" name="condition" value="{$vo['condition']}" class="text" style="width:70px;"/>
								</div>
								</eq>
							</div>
							<div class="error_message" style="float:left;display:none;">
								<div style="color:red;">*</div>
							</div>
							<div style="color:#c2c2c2;">&nbsp;&nbsp;&nbsp;{$vo['attr']}</div>
						</div>
	           		</volist>
	        	</div>
			</div>
					</td>
					<td valign="top" style="width:650px;">
							<div style="line-height:30px;">
								总共 <font id="stocks_num" style="color:red;font-weight:bold;">{$data['stocks']|count}</font> 只股票
							</div>
							<table border="1px" style="font-size:9px;border:1px solid #d2d2d2;">
								<thead>
									<tr>
										<th style="width:40px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
										<th>7天</th>
										<th>14天</th>
										<th>21天</th>
										<th>1月</th>
										<th>3月</th>
										<th>6月</th>
										<th>1年</th>
										<th>2年</th>
										<th>3年</th>
										<th>4年</th>
										<th>5年</th>
										<th>6年</th>
										<th>7年</th>
										<th>8年</th>
										<th>9年</th>
										<th>10年</th>
									</tr>
								</thead>
								<tbody id="changeRate_table">
									<tr>
										<td style="width:40px;">去沪<br>深300</td>
										<td>{$data['changeRate']['day7_change_rate']}</td>
										<td>{$data['changeRate']['day14_change_rate']}</td>
										<td>{$data['changeRate']['day21_change_rate']}</td>
										<td>{$data['changeRate']['month1_change_rate']}</td>
										<td>{$data['changeRate']['month3_change_rate']}</td>
										<td>{$data['changeRate']['month6_change_rate']}</td>
										<td>{$data['changeRate']['year1_change_rate']}</td>
										<td>{$data['changeRate']['year2_change_rate']}</td>
										<td>{$data['changeRate']['year3_change_rate']}</td>
										<td>{$data['changeRate']['year4_change_rate']}</td>
										<td>{$data['changeRate']['year5_change_rate']}</td>
										<td>{$data['changeRate']['year6_change_rate']}</td>
										<td>{$data['changeRate']['year7_change_rate']}</td>
										<td>{$data['changeRate']['year8_change_rate']}</td>
										<td>{$data['changeRate']['year9_change_rate']}</td>
										<td>{$data['changeRate']['year10_change_rate']}</td>
									</tr>
								</tbody>
							</table>
						<div class="data-table" style="width:100%;height:500px;overflow:auto;overflow-x: hidden">
							<table>
								<thead>
								<tr style="text-align:right;">
									<th style="text-align:left;">股票代码</th>
									<th style="text-align:left;">公司</th>
									<th style="text-align:right;">涨跌幅</th>
									<th style="text-align:right;">价格</th>
									<th style="text-align:right;">总市值</th>
									<th style="text-align:right;">市盈率</th>
								</tr>
								</thead>
								<tbody id="stocks_table">
								<volist name="data['stocks']" id="stock">
								<tr style="text-align:right;">
									<td style="text-align:left;">{$stock.market}.{$stock.code}</td>
									<td style="text-align:left;">{$stock.name}</td>
									<td>{$stock.change_rate}</td>
									<td>{$stock.curr_price}</td>
									<td>{$stock.zongshizhi}</td>
									<td>{$stock.shiyinglvttm}</td>
								</tr>
								</volist>
								</tbody>
							</table>
						</div>
					</td>
				</tr>

			</table>
			
        </div>

		<div class="form-item cf">
			<button class="btn submit-btn ajax-post hidden" id="submit" type="submit" target-form="form-horizontal">确 定</button>
			<a class="btn btn-return" href="{$Think.cookie.__forward__}">返 回</a>
			
			<input type="hidden" name="id" value="{$data.id|default=''}"/>
		</div>
	</form>
	</div>
</div>
<div id="filter_html"  style="display:none;">
	<div class="filter" style="line-height:35px;clear:both;">
		<div style="float:left;width:25px;">
			<input type="checkbox" name="join" checked>
		</div>
		<div style="float:left;width:200px;">
			<select class="stock_filter_class">
			<volist name="stockFilters" id="filter">
			<option value="{$filter.name}" data-type="{$filter.type}">{$filter.title}</option>
			</volist>
			</select>
		</div>
		<div class="condition_class" style="float:left;min-width:120px;">
			<div class="type type_num">
				<input type="text" name="condition" value="" class="text" style="width:100px;"/>
			</div>
			<div class="type type_str">
				<input type="radio" name="bool" value="true">包含
				<input type="radio" name="bool" value="false">不包含 
				<input type="text" name="condition" value="" class="text" style="width:70px;"/>
			</div>
			<div class="type type_bool">
				&nbsp;
			</div>
			<div class="type type_num_menu">
				<select name="menu">
					<option>筹资现金</option>
					<option>经营现金</option>
					<option>投资现金</option>
				</select>
				<input type="text" name="condition" value="" class="text" style="width:70px;"/>
			</div>
			<div class="type type_num_day1">
				近<input type="text" name="day1" value="" class="text" style="width:30px;"/>天，
				<input type="text" name="condition" value="" class="text" style="width:70px;"/>
			</div>
			<div class="type type_num_day2">
				从<input type="text" name="day1" value="" class="text" style="width:30px;"/>天，
				到<input type="text" name="day2" value="" class="text" style="width:30px;"/>天，
				<input type="text" name="condition" value="" class="text" style="width:70px;"/>
			</div>
		</div>
		<div class="error_message" style="float:left;display:none;">
			<div style="color:red;">*</div>
		</div>
		<div style="color:#c2c2c2;">&nbsp;&nbsp;&nbsp;{$vo['attr']}</div>
	</div>
</div>
</block>

<block name="script">
<link href="__STATIC__/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">
<php>if(C('COLOR_STYLE')=='blue_color') echo '<link href="__STATIC__/datetimepicker/css/datetimepicker_blue.css" rel="stylesheet" type="text/css">';</php>
<link href="__STATIC__/datetimepicker/css/dropdown.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="__STATIC__/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script type="text/javascript" src="__STATIC__/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
<script type="text/javascript" src="__STATIC__/jquery.blockUI.js"></script>
<script type="text/javascript">
String.prototype.startWith=function(str){
  if(str==null||str==""||this.length==0||str.length>this.length)
   return false;
  if(this.substr(0,str.length)==str)
     return true;
  else
     return false;
  return true;
}
var isBlank=function(str){
	if(str==null||str==""||str===undefined){
		return true;
	}
	return false;
}

$(function(){
	var condition=function(type){
		var obj=$("#filter_html .condition_class .type_"+type);
		if(type=="str"){
			var rand=parseInt(Math.random()*2000000000);
			obj.find("input[type=radio]").each(function(){
				$(this).attr('name','bool'+rand);
			});
		}
		return obj.clone();
	}

	var getType=function(obj){
		var val=obj.val();
		var arr=obj.children();
		for(var i=0;i<arr.length;i++){
			var v=$(arr.get(i)).val();
			if(v==val){
				return $(arr.get(i)).data('type');
			}
		}
	}

	var bindAction=function(){
		console.log("bindAction");
		$(".stock_filter_class").each(function(){
			$(this).unbind('change');
			$(this).change(function(e){

				var type=getType($(e.target));
				console.log("type="+type);
				var obj=$(this).parent();
				var condition_class=obj.next(".condition_class");
				condition_class.html(condition(type));

				bindConvert();
			});
		});
	}
	bindAction();

	var isNumber=function(num){
		//^(-?\d+)(\.\d+)?$
		var reg = /^(-?\d+)(\.\d+)?$/;
		if(reg.test(num)){
			return true;
		}

		reg=/^-?\d+$/;
		if(reg.test(num)){
			return true;
		}

		return false;
	}

	var numValid=function(condition){
		if(condition==null||condition==""||condition==undefined){
			return false;
		}
		var num="";
		if(condition.startWith("<=")){
			num=condition.substring(2);
		}else if(condition.startWith(">=")){
			num=condition.substring(2);
		}else if(condition.startWith("<")){
			num=condition.substring(1);
		}else if(condition.startWith(">")){
			num=condition.substring(1);
		}

		if(isNumber(num)){
			return true;
		}else{
			return false;
		}
	}

	var convert=function(){
		$("#filters .filter").each(function(){
			var stock_filter_class=$(this).find(".stock_filter_class").val();
			var filter=stock_filter_class;

			var typeDiv=$(this).find(".type");
			var error_message=$(this).find(".error_message");

			error_message.hide();

			if(typeDiv.hasClass("type_num")){
				var condition=typeDiv.find("input[name=condition]").val();
				if(!numValid(condition)){
					error_message.show();
				}
			}else if(typeDiv.hasClass("type_str")){
				var bool=typeDiv.find("input[type=radio]:checked").val();
				var condition=typeDiv.find("input[name=condition]").val();
				
				if(!(bool=="false" || bool=="true")){
					error_message.show();
				}
				if(isBlank(condition)){
					error_message.show();
				}

			}else if(typeDiv.hasClass("type_bool")){

			}else if(typeDiv.hasClass("type_num_menu")){
				var menu=typeDiv.find("select[name=menu]").val();
				var condition=typeDiv.find("input[name=condition]").val();
				
			}else if(typeDiv.hasClass("type_num_day1")){
				var day1=typeDiv.find("input[name=day1]").val();
				var condition=typeDiv.find("input[name=condition]").val();
				
			}else if(typeDiv.hasClass("type_num_day2")){
				var day1=typeDiv.find("input[name=day1]").val();
				var day2=typeDiv.find("input[name=day2]").val();
				var condition=typeDiv.find("input[name=condition]").val();
				
			}
		});


		var dataArray=new Array();
		$("#filters .filter").each(function(){
			var join=$(this).find("input[name=join]").is(':checked')==true;
			if(join){
				var data={};

				var stock_filter_class=$(this).find(".stock_filter_class").val();
				data.filter=stock_filter_class;

				var typeDiv=$(this).find(".type");

				if(typeDiv.hasClass("type_num")){
					var condition=typeDiv.find("input[name=condition]").val();
					data.condition=condition;
				}else if(typeDiv.hasClass("type_str")){
					var bool=typeDiv.find("input[type=radio]:checked").val();
					var condition=typeDiv.find("input[name=condition]").val();
					if(bool=="true"){
						data.condition="IN"+condition;
					}else{
						data.condition="!IN"+condition;
					}
				}else if(typeDiv.hasClass("type_bool")){

				}else if(typeDiv.hasClass("type_num_menu")){
					var menu=typeDiv.find("select[name=menu]").val();
					var condition=typeDiv.find("input[name=condition]").val();
					data.condition=menu+","+condition;
				}else if(typeDiv.hasClass("type_num_day1")){
					var day1=typeDiv.find("input[name=day1]").val();
					var condition=typeDiv.find("input[name=condition]").val();
					data.condition=day1+","+condition;
				}else if(typeDiv.hasClass("type_num_day2")){
					var day1=typeDiv.find("input[name=day1]").val();
					var day2=typeDiv.find("input[name=day2]").val();
					var condition=typeDiv.find("input[name=condition]").val();
					data.condition=day1+","+day2+","+condition;
				}
				dataArray[dataArray.length]=data;
			}

		});

		$("input[name=filters]").val(JSON.stringify(dataArray));
	};
	
	var bindConvert=function(){
		$("#filters input").each(function(){
			$(this).unbind('change');
			$(this).unbind('focusout');
			$(this).change(function(){
				convert();
			});
			$(this).focusout(function(){
				convert();
			});
		});

		$("#filters select").each(function(){
			if($(this).hasClass("stock_filter_class")){
				bindAction();
			}else{
				$(this).unbind('change');
				$(this).unbind('focusout');
				$(this).change(function(){
					convert();
				});
				$(this).focusout(function(){
					convert();
				});
			}
			
		});
		convert();
	};

	bindConvert();

	$("#add_filter").click(function(){
		var type=getType($('#filter_html .stock_filter_class'));
		$("#filters").append($("#filter_html").html());
		var x=$("#filters").children().last();
		x.children(".condition_class").html(condition(type));

		bindConvert();
	});

	$("#run_filter").click(function(){
		$.blockUI({message:"等待运行结果......",css:{"height":'100px',"line-height":'100px',"font-size":'40px'}});
		var run_filter_url=$("input[name=run_filter_url]").val();
		var filters=$("input[name=filters]").val();
		
		var stocks_url=$("input[name=stocks_url]").val();

		$.post(run_filter_url,{filters:filters},function(data){
			var html="";
			var stocks_num=0;
			if(data.stocks){
				for(var i=0;i<data.stocks.length;i++){
					html+="<tr style=\"text-align:right;\">";
						html+=("<td style=\"text-align:left;\">"+data.stocks[i]['market']+"."+data.stocks[i]['code']+"</td>")
						html+=("<td style=\"text-align:left;\">"+data.stocks[i]['name']+"</td>")
						html+=("<td>"+data.stocks[i]['change_rate']+"</td>")
						html+=("<td>"+data.stocks[i]['curr_price']+"</td>")
						html+=("<td>"+data.stocks[i]['zongshizhi']+"</td>")
						html+=("<td>"+data.stocks[i]['shiyinglvttm']+"</td>")
					html+="</tr>";
				}
				stocks_num=data.stocks.length;
			}
			$("#stocks_table").html(html);
			$("#stocks_num").text(stocks_num);

			html="";
			if(data.changeRate){
				html+="<tr>";
					html+="<td style=\"width:40px;\">去沪<br>深300</td>";
					html+="<td>"+data.changeRate['day7_change_rate']+"</td>";
					html+="<td>"+data.changeRate['day14_change_rate']+"</td>";
					html+="<td>"+data.changeRate['day21_change_rate']+"</td>";
					html+="<td>"+data.changeRate['month1_change_rate']+"</td>";
					html+="<td>"+data.changeRate['month3_change_rate']+"</td>";
					html+="<td>"+data.changeRate['month6_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year1_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year2_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year3_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year4_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year5_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year6_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year7_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year8_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year9_change_rate']+"</td>";
					html+="<td>"+data.changeRate['year10_change_rate']+"</td>";
				html+="</tr>";
			}
			$("#changeRate_table").html(html);

			$.unblockUI();

			//stocks_table

			/*
			$.post(stocks_url,{id:data.id},function(stocks){
				alert(stocks);
				console.log(stocks);
			});
	*/
		});
	});

	
	$('#submit').click(function(){
		convert();
		$('#form').submit();
	});

	
    $('.time').datetimepicker({
        format: 'yyyy-mm-dd hh:ii',
        language:"zh-CN",
        minView:2,
        autoclose:true
    });
    showTab();

	<if condition="C('OPEN_DRAFTBOX') and (ACTION_NAME eq 'add' or $data['status'] eq 3)">
	//保存草稿
	var interval;
	$('#autoSave').click(function(){
        var target_form = $(this).attr('target-form');
        var target = $(this).attr('url')
        var form = $('.'+target_form);
        var query = form.serialize();
        var that = this;

        $(that).addClass('disabled').attr('autocomplete','off').prop('disabled',true);
        $.post(target,query).success(function(data){
            if (data.status==1) {
                updateAlert(data.info ,'alert-success');
                $('input[name=id]').val(data.data.id);
            }else{
                updateAlert(data.info);
            }
            setTimeout(function(){
                $('#top-alert').find('button').click();
                $(that).removeClass('disabled').prop('disabled',false);
            },1500);
        })

        //重新开始定时器
        clearInterval(interval);
        autoSaveDraft();
        return false;
    });

	//Ctrl+S保存草稿
	$('body').keydown(function(e){
		if(e.ctrlKey && e.which == 83){
			$('#autoSave').click();
			return false;
		}
	});

	//每隔一段时间保存草稿
	function autoSaveDraft(){
		interval = setInterval(function(){
			//只有基础信息填写了，才会触发
			var title = $('input[name=title]').val();
			var name = $('input[name=name]').val();
			var des = $('textarea[name=description]').val();
			if(title != '' || name != '' || des != ''){
				$('#autoSave').click();
			}
		}, 1000*parseInt({:C('DRAFT_AOTOSAVE_INTERVAL')}));
	}
	autoSaveDraft();

	</if>

	

});
</script>
</block>
